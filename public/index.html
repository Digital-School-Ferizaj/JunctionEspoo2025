<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Amily Companion</title>
    <link rel="icon" type="image/png" href="/logo.png" />
    <script
      crossorigin
      src="https://unpkg.com/react@18.3.1/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18.3.1/umd/react-dom.development.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              display: ["DM Sans", "system-ui", "sans-serif"],
              body: ["DM Sans", "system-ui", "sans-serif"],
            },
          },
        },
      };
    </script>
    <style>
      body {
        background-color: #fffff0;
        color: #545454;
        font-family: "DM Sans", system-ui, sans-serif;
      }
      .tab-bar-shadow {
        box-shadow: 0 -6px 18px rgba(84, 84, 84, 0.12);
      }
      .material-symbols-rounded {
        font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 24;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
    </style>
  </head>
  <body class="bg-[#FFFFF0] text-[#545454]">
    <div id="root"></div>
    <script src="/state/wellnessStore.js"></script>
    <script type="text/babel" src="/components/icons.jsx"></script>
    <script type="text/babel" src="/components/tabs/HomeTab.jsx"></script>
    <script type="text/babel" src="/components/tabs/SafetyTab.jsx"></script>
    <script type="text/babel" src="/components/tabs/WellnessTab.jsx"></script>
    <script type="text/babel" src="/components/tabs/MemoriesTab.jsx"></script>
    <script type="text/babel" src="/components/tabs/ChatTab.jsx"></script>
    <script type="text/babel" src="/components/tabs/BuddyTab.jsx"></script>
    <script type="text/babel">
      const { useState, useEffect } = React;
      const { createRoot } = ReactDOM;
      const Icons = window.AmilyIcons || {};
      const {
        ShieldIcon,
        HeartIcon,
        BookOpenIcon,
        UsersIcon,
        PhoneIcon,
        MenuIcon,
        XIcon,
        ChatBubbleIcon,
        BuddyIcon,
        WellnessLeafIcon,
        MemorySparkIcon,
      } = Icons;
      const Tabs = window.AmilyTabs || {};
      const {
        HomeTab,
        SafetyTab,
        WellnessTab,
        MemoriesTab,
        ChatTab,
        BuddyTab,
      } = Tabs;
      const appPages = ["memories", "wellness", "chat", "safety", "buddy"];
      const STORAGE_KEYS = {
        token: "amily:token",
        user: "amily:user",
        userName: "amily:user:name",
      };
      const readStoredValue = (key, fallback = null) => {
        try {
          if (typeof window === "undefined" || !window.localStorage) {
            return fallback;
          }
          const raw = window.localStorage.getItem(key);
          return raw === null ? fallback : JSON.parse(raw);
        } catch {
          return fallback;
        }
      };
      const writeStoredValue = (key, value) => {
        try {
          if (typeof window === "undefined" || !window.localStorage) {
            return;
          }
          if (value === null || value === undefined) {
            window.localStorage.removeItem(key);
          } else {
            window.localStorage.setItem(key, JSON.stringify(value));
          }
        } catch {
          // Ignore storage errors in demo mode
        }
      };
      function FeatureCard({ icon: Icon, title, description, note }) {
        return (
          <div className="rounded-[28px] border border-[#f4d3b4] bg-white/90 shadow-md p-6 space-y-3">
            {" "}
            <div className="inline-flex items-center justify-center w-12 h-12 rounded-2xl bg-[#fde9dc] text-[#db7758]">
              {" "}
              <Icon />{" "}
            </div>{" "}
            <h3 className="text-xl font-bold">{title}</h3>{" "}
            <p className="text-sm text-[#6b6b6b] leading-relaxed">
              {description}
            </p>{" "}
            {note && (
              <p className="text-[11px] font-semibold uppercase tracking-[0.3em] text-[#db7758]">
                {note}
              </p>
            )}{" "}
          </div>
        );
      }
      function Navigation({ isLoggedIn, currentPage, onNavigate, onLogout }) {
        const [menuOpen, setMenuOpen] = useState(false);
        const navItems = isLoggedIn
          ? appPages.map((page) => ({
              id: page,
              label: page.charAt(0).toUpperCase() + page.slice(1),
            }))
          : [
              { id: "home", label: "Home" },
              { id: "login", label: "Sign in" },
              { id: "signup", label: "Create account" },
            ];
        const handleNav = (id) => {
          setMenuOpen(false);
          onNavigate(id);
        };
        return (
          <header className="sticky top-0 z-40 bg-[#FFFFF0]/95 border-b border-[#f4d3b4] backdrop-blur">
            {" "}
            <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
              {" "}
              <button
                type="button"
                onClick={() => handleNav(isLoggedIn ? "chat" : "home")}
                className="flex items-center gap-3"
              >
                {" "}
                <img
                  src="/logo.png"
                  alt="Amily"
                  className="w-12 h-12 rounded-2xl"
                />{" "}
                <div className="text-left">
                  {" "}
                  <p className="text-base font-semibold">
                    Amily Companion
                  </p>{" "}
                  <p className="text-xs text-[#db7758]">
                    {" "}
                    {isLoggedIn
                      ? "You are inside the platform"
                      : "Calm digital company for elders"}{" "}
                  </p>{" "}
                </div>{" "}
              </button>{" "}
              <div className="hidden md:flex items-center gap-2">
                {" "}
                {navItems.map((item) => (
                  <button
                    key={item.id}
                    type="button"
                    onClick={() => handleNav(item.id)}
                    className={`px-4 py-2 rounded-2xl text-sm font-semibold transition-colors ${currentPage === item.id ? "bg-[#db7758] text-white" : "text-[#545454] hover:bg-white"}`}
                  >
                    {" "}
                    {item.label}{" "}
                  </button>
                ))}{" "}
              </div>{" "}
              <div className="flex items-center gap-3">
                {" "}
                {isLoggedIn && (
                  <button
                    type="button"
                    onClick={onLogout}
                    className="px-4 py-2 rounded-2xl border border-[#f4d3b4] text-sm font-semibold"
                  >
                    {" "}
                    Log out{" "}
                  </button>
                )}{" "}
                <button
                  type="button"
                  className="md:hidden p-2 rounded-2xl border border-[#f4d3b4]"
                  onClick={() => setMenuOpen((open) => !open)}
                >
                  {" "}
                  {menuOpen ? <XIcon /> : <MenuIcon />}{" "}
                </button>{" "}
              </div>{" "}
            </div>{" "}
            {menuOpen && (
              <div className="md:hidden border-t border-[#f4d3b4] bg-white">
                {" "}
                <div className="px-4 py-3 space-y-2">
                  {" "}
                  {navItems.map((item) => (
                    <button
                      key={item.id}
                      type="button"
                      onClick={() => handleNav(item.id)}
                      className={`w-full text-left px-4 py-2 rounded-2xl text-sm font-semibold ${currentPage === item.id ? "bg-[#db7758] text-white" : "text-[#545454]"}`}
                    >
                      {" "}
                      {item.label}{" "}
                    </button>
                  ))}{" "}
                </div>{" "}
              </div>
            )}{" "}
          </header>
        );
      }
      function MobileTabBar({ currentPage, onNavigate }) {
        const tabs = [
          { id: "memories", label: "Memories", icon: BookOpenIcon },
          { id: "wellness", label: "Wellness", icon: WellnessLeafIcon },
          { id: "chat", label: "Chat", icon: ChatBubbleIcon },
          { id: "safety", label: "Safety", icon: ShieldIcon },
          { id: "buddy", label: "Buddy", icon: BuddyIcon },
        ];
        return (
          <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-[#f4d3b4] tab-bar-shadow md:hidden">
            {" "}
            <div className="max-w-5xl mx-auto flex items-center justify-between px-4 py-2">
              {" "}
              {tabs.map((tab) => (
                <button
                  key={tab.id}
                  type="button"
                  onClick={() => onNavigate(tab.id)}
                  className={`flex flex-col items-center gap-1 text-xs font-semibold ${currentPage === tab.id ? "text-[#db7758]" : "text-[#9b9b9b]"}`}
                >
                  {" "}
                  <span className="w-10 h-10 rounded-2xl flex items-center justify-center border border-[#f4d3b4]">
                    {" "}
                    <tab.icon />{" "}
                  </span>{" "}
                  {tab.label}{" "}
                </button>
              ))}{" "}
            </div>{" "}
          </nav>
        );
      }
      function LoginPage({ onAuthSuccess }) {
        const [email, setEmail] = useState("");
        const [password, setPassword] = useState("");
        const [status, setStatus] = useState(null);
        const handleSubmit = async (event) => {
          event.preventDefault();
          setStatus({ type: "info", message: "Signing you in..." });
          try {
            const res = await fetch("/api/auth/login", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email, password }),
            });
            const data = await res.json();
            if (!res.ok) {
              throw new Error(data.error || "Login failed");
            }
            setStatus({ type: "success", message: "Welcome back!" });
            onAuthSuccess?.(
              data.userId || data.user?.id || "demo-user",
              data.token || null,
              data.fullName || data.name || null
            );
          } catch (error) {
            setStatus({ type: "error", message: error.message });
          }
        };
        return (
          <section className="px-4 py-12 pb-28 bg-[#FFFFF0]">
            {" "}
            <div className="max-w-md mx-auto rounded-[32px] border border-[#f4d3b4] bg-white/95 shadow-lg p-6 space-y-5">
              {" "}
              <div>
                {" "}
                <p className="text-xs font-semibold uppercase tracking-[0.3em] text-[#db7758]">
                  Sign in
                </p>{" "}
                <h2 className="text-3xl font-bold">Enter the platform</h2>{" "}
                <p className="text-sm text-[#6b6b6b]">
                  After signing in, the homepage is replaced with the five-tab
                  layout.
                </p>{" "}
              </div>{" "}
              {status && (
                <div
                  className={`rounded-2xl px-4 py-3 text-sm ${status.type === "error" ? "bg-[#ffe3dd] text-[#a6523b]" : status.type === "success" ? "bg-[#e3f7d8] text-[#3f6c42]" : "bg-[#fff6ea] text-[#6b6b6b]"}`}
                >
                  {" "}
                  {status.message}{" "}
                </div>
              )}{" "}
              <form onSubmit={handleSubmit} className="space-y-4">
                {" "}
                <div className="space-y-2">
                  {" "}
                  <label className="text-sm font-semibold">Email</label>{" "}
                  <input
                    type="email"
                    value={email}
                    onChange={(event) => setEmail(event.target.value)}
                    className="w-full rounded-2xl border border-[#f4d3b4] px-4 py-3 focus:outline-none focus:ring-2 focus:ring-[#db7758]"
                    required
                  />{" "}
                </div>{" "}
                <div className="space-y-2">
                  {" "}
                  <label className="text-sm font-semibold">Password</label>{" "}
                  <input
                    type="password"
                    value={password}
                    onChange={(event) => setPassword(event.target.value)}
                    className="w-full rounded-2xl border border-[#f4d3b4] px-4 py-3 focus:outline-none focus:ring-2 focus:ring-[#db7758]"
                    required
                  />{" "}
                </div>{" "}
                <button
                  type="submit"
                  className="w-full px-4 py-3 rounded-2xl bg-[#db7758] text-white font-semibold"
                >
                  {" "}
                  Sign in securely{" "}
                </button>{" "}
              </form>{" "}
            </div>{" "}
          </section>
        );
      }
      function SignupPage({ onAuthSuccess }) {
        const [email, setEmail] = useState("");
        const [password, setPassword] = useState("");
        const [name, setName] = useState("");
        const [status, setStatus] = useState(null);
        const handleSubmit = async (event) => {
          event.preventDefault();
          setStatus({ type: "info", message: "Creating your access..." });
          try {
            const res = await fetch("/api/auth/signup", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email, password, name, fullName: name }),
            });
            const data = await res.json();
            if (!res.ok) {
              throw new Error(data.error || "Signup failed");
            }
            setStatus({
              type: "success",
              message: "Account created! Redirecting...",
            });
            onAuthSuccess?.(
              data.userId || data.user?.id || "demo-user",
              data.token || null,
              data.fullName || name || null
            );
          } catch (error) {
            setStatus({ type: "error", message: error.message });
          }
        };
        return (
          <section className="px-4 py-12 pb-28 bg-[#FFFFF0]">
            {" "}
            <div className="max-w-md mx-auto rounded-[32px] border border-[#f4d3b4] bg-white/95 shadow-lg p-6 space-y-5">
              {" "}
              <div>
                {" "}
                <p className="text-xs font-semibold uppercase tracking-[0.3em] text-[#db7758]">
                  Family onboarding
                </p>{" "}
                <h2 className="text-3xl font-bold">Create a calm space</h2>{" "}
                <p className="text-sm text-[#6b6b6b]">
                  Only family members trusted by the elder should create
                  accounts.
                </p>{" "}
              </div>{" "}
              {status && (
                <div
                  className={`rounded-2xl px-4 py-3 text-sm ${status.type === "error" ? "bg-[#ffe3dd] text-[#a6523b]" : status.type === "success" ? "bg-[#e3f7d8] text-[#3f6c42]" : "bg-[#fff6ea] text-[#6b6b6b]"}`}
                >
                  {" "}
                  {status.message}{" "}
                </div>
              )}{" "}
              <form onSubmit={handleSubmit} className="space-y-4">
                {" "}
                <div className="space-y-2">
                  {" "}
                  <label className="text-sm font-semibold">
                    Your name
                  </label>{" "}
                  <input
                    type="text"
                    value={name}
                    onChange={(event) => setName(event.target.value)}
                    className="w-full rounded-2xl border border-[#f4d3b4] px-4 py-3 focus:outline-none focus:ring-2 focus:ring-[#db7758]"
                    required
                  />{" "}
                </div>{" "}
                <div className="space-y-2">
                  {" "}
                  <label className="text-sm font-semibold">Email</label>{" "}
                  <input
                    type="email"
                    value={email}
                    onChange={(event) => setEmail(event.target.value)}
                    className="w-full rounded-2xl border border-[#f4d3b4] px-4 py-3 focus:outline-none focus:ring-2 focus:ring-[#db7758]"
                    required
                  />{" "}
                </div>{" "}
                <div className="space-y-2">
                  {" "}
                  <label className="text-sm font-semibold">Password</label>{" "}
                  <input
                    type="password"
                    value={password}
                    onChange={(event) => setPassword(event.target.value)}
                    className="w-full rounded-2xl border border-[#f4d3b4] px-4 py-3 focus:outline-none focus:ring-2 focus:ring-[#db7758]"
                    required
                  />{" "}
                </div>{" "}
                <button
                  type="submit"
                  className="w-full px-4 py-3 rounded-2xl bg-[#db7758] text-white font-semibold"
                >
                  {" "}
                  Create account{" "}
                </button>{" "}
              </form>{" "}
            </div>{" "}
          </section>
        );
      }
      function App() {
        const initialToken = readStoredValue(STORAGE_KEYS.token, null);
        const initialUserId = readStoredValue(STORAGE_KEYS.user, "demo-user") || "demo-user";
        const initialUserName =
          readStoredValue(STORAGE_KEYS.userName, "Companion friend") || "Companion friend";
        const [currentPage, setCurrentPage] = useState(initialToken ? "chat" : "home");
        const [isLoggedIn, setIsLoggedIn] = useState(Boolean(initialToken));
        const [authToken, setAuthToken] = useState(initialToken);
        const [activeUserId, setActiveUserId] = useState(initialUserId);
        const [activeUserName, setActiveUserName] = useState(initialUserName);
        const handleNavigate = (pageId) => {
          if (isLoggedIn) {
            if (!appPages.includes(pageId)) return;
            setCurrentPage(pageId);
          } else if (appPages.includes(pageId)) {
            setCurrentPage("login");
          } else {
            setCurrentPage(pageId);
          }
          window.scrollTo({ top: 0, behavior: "smooth" });
        };
        const handleAuthSuccess = (newUserId = "demo-user", token = null, fullName = null) => {
          const resolvedUserId = newUserId || "demo-user";
          const resolvedName = (fullName && fullName.trim()) || "Companion friend";
          setIsLoggedIn(true);
          setActiveUserId(resolvedUserId);
          setAuthToken(token);
          setActiveUserName(resolvedName);
          writeStoredValue(STORAGE_KEYS.user, resolvedUserId);
          writeStoredValue(STORAGE_KEYS.token, token || null);
          writeStoredValue(STORAGE_KEYS.userName, resolvedName);
          setCurrentPage("chat");
          window.AmilyWellness?.setUser?.(resolvedUserId);
        };
        const handleLogout = () => {
          setIsLoggedIn(false);
          setActiveUserId("demo-user");
          setAuthToken(null);
          setActiveUserName("Companion friend");
          setCurrentPage("home");
          writeStoredValue(STORAGE_KEYS.user, "demo-user");
          writeStoredValue(STORAGE_KEYS.token, null);
          writeStoredValue(STORAGE_KEYS.userName, "Companion friend");
          window.AmilyWellness?.setUser?.("demo-user");
        };
        useEffect(() => {
          window.AmilyWellness?.setUser?.(activeUserId || "demo-user");
        }, [activeUserId]);

        useEffect(() => {
          if (!isLoggedIn || !authToken) return;
          if (activeUserName && activeUserName !== "Companion friend") return;

          let cancelled = false;
          fetch("/api/profile", {
            headers: {
              Authorization: `Bearer ${authToken}`,
            },
          })
            .then((res) => res.json().catch(() => null))
            .then((payload) => {
              if (cancelled) return;
              if (payload?.success && payload.data?.name) {
                const fetchedName = payload.data.name;
                setActiveUserName(fetchedName);
                writeStoredValue(STORAGE_KEYS.userName, fetchedName);
              }
            })
            .catch(() => {
              // Non-critical
            });

          return () => {
            cancelled = true;
          };
        }, [isLoggedIn, authToken, activeUserId, activeUserName]);
        const features = [
          {
            icon: ChatBubbleIcon,
            title: "Chat (main tab)",
            description:
              "Warm voice and text chat powered by Gemini and ElevenLabs. The tab sits in the middle for quick access.",
            note: "Primary in tab bar",
          },
          {
            icon: WellnessLeafIcon,
            title: "Wellness profile",
            description:
              "Personal stats, photo, and only the recommendations that matter. Works like a profile card.",
            note: "Left of Chat",
          },
          {
            icon: ShieldIcon,
            title: "Safety board",
            description:
              "Large buttons for emergency services, family, and doctors. Care circle is notified quietly.",
            note: "Right of Chat",
          },
          {
            icon: MemorySparkIcon,
            title: "Memories",
            description:
              "Record small stories and share them with relatives without extra menus or steps.",
            note: "First tab on the left",
          },
          {
            icon: BuddyIcon,
            title: "Buddy matches",
            description:
              "Connect elders with nearby friends who love similar hobbies. Families see every wave.",
            note: "Last tab on the right",
          },
        ];
        return (
          <div className="min-h-screen pb-24 md:pb-10">
            {" "}
            <Navigation
              isLoggedIn={isLoggedIn}
              currentPage={currentPage}
              onNavigate={handleNavigate}
              onLogout={handleLogout}
            />{" "}
            <main className="pt-6 space-y-10">
              {" "}
              {!isLoggedIn && currentPage === "home" && HomeTab && (
                <HomeTab
                  onNavigate={handleNavigate}
                  features={features}
                  FeatureCard={FeatureCard}
                />
              )}{" "}
              {isLoggedIn && currentPage === "memories" && MemoriesTab && (
                <MemoriesTab userId={activeUserId} authToken={authToken} />
              )}{" "}
              {isLoggedIn && currentPage === "wellness" && WellnessTab && (
                <WellnessTab userId={activeUserId} authToken={authToken} userName={activeUserName} />
              )}{" "}
              {isLoggedIn && currentPage === "chat" && ChatTab && (
                <ChatTab userId={activeUserId} authToken={authToken} />
              )}{" "}
              {isLoggedIn && currentPage === "safety" && SafetyTab && (
                <SafetyTab userId={activeUserId} authToken={authToken} />
              )}{" "}
              {isLoggedIn && currentPage === "buddy" && BuddyTab && (
                <BuddyTab userId={activeUserId} authToken={authToken} />
              )}{" "}
              {!isLoggedIn && currentPage === "login" && (
                <LoginPage onAuthSuccess={handleAuthSuccess} />
              )}{" "}
              {!isLoggedIn && currentPage === "signup" && (
                <SignupPage onAuthSuccess={handleAuthSuccess} />
              )}{" "}
            </main>{" "}
            <footer className="mt-12 px-4 pb-12">
              {" "}
              <div className="max-w-6xl mx-auto rounded-[32px] border border-[#f4d3b4] bg-white/90 p-6 text-center text-sm text-[#6b6b6b]">
                {" "}
                <p>
                  Amily Companion built for Junction Espoo 2025 by Ilirians Shkolla Digjitale Ferizaj Team.{" "}
                </p>{" "}
              </div>{" "}
            </footer>{" "}
            {isLoggedIn && (
              <MobileTabBar
                currentPage={currentPage}
                onNavigate={handleNavigate}
              />
            )}{" "}
          </div>
        );
      }
      const root = createRoot(document.getElementById("root"));
      root.render(React.createElement(App));
    </script>
  </body>
</html>
